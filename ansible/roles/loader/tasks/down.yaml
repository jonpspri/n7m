---
#
#  Note that we do NOT deallocate the task definitions because they're versioned in Amazon,
#  and there's no charge for their definition.
#

# Stop any running tasks in the cluster before deletion
- name: List running tasks in cluster
  ansible.builtin.command:
    cmd: >
      aws ecs list-tasks
      --cluster {{ prefix_v }}-ecs-cluster
      --desired-status RUNNING
      --region {{ region_v }}
      --output json
  register: running_tasks_result
  changed_when: false
  failed_when: false

- name: Stop running tasks
  ansible.builtin.command:
    cmd: >
      aws ecs stop-task
      --cluster {{ prefix_v }}-ecs-cluster
      --task {{ item }}
      --region {{ region_v }}
  loop: "{{ (running_tasks_result.stdout | from_json).taskArns }}"
  when:
    - running_tasks_result.rc == 0
    - (running_tasks_result.stdout | from_json).taskArns | length > 0
  changed_when: true

# Wait for tasks to stop
- name: Wait for tasks to stop
  ansible.builtin.pause:
    seconds: 10
    prompt: "Waiting for tasks to stop..."
  when:
    - running_tasks_result.rc == 0
    - (running_tasks_result.stdout | from_json).taskArns | length > 0

# Delete the ECS cluster
- name: Deallocate ECS cluster
  community.aws.ecs_cluster:
    name: "{{ prefix_v }}-ecs-cluster"
    state: absent
  register: cluster_delete_result
  retries: 5
  delay: 10
  until: cluster_delete_result is succeeded

# Delete the EFS file system (chargeable)
- name: Deallocate EFS partition
  community.aws.efs:
    name: "{{ prefix_v }}-data"
    state: absent
  register: efs_delete_result
  retries: 5
  delay: 10
  until: efs_delete_result is succeeded

# Clean up IAM execution role (no charge, but good practice)
- name: Delete IAM execution role
  amazon.aws.iam_role:
    name: "{{ prefix_v }}-container-execution-role"
    state: absent
